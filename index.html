<!DOCTYPE html>
<html lang="ja" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cyber Run: Android Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0b0f1a; color: #e5e7eb; }
        .font-mono-digit { font-family: 'ui-monospace', monospace; letter-spacing: -0.05em; }
    </style>
</head>
<body class="p-4 min-h-screen flex justify-center pb-24">

    <div class="w-full max-w-md">
        <header class="flex justify-between items-end mb-6 mt-4">
            <div>
                <h1 class="text-2xl font-black italic tracking-tighter bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-cyan-400">
                    CYBER RUN ANDROID
                </h1>
                <p id="accuracy-text" class="text-[9px] text-gray-500 font-bold uppercase tracking-widest mt-1">GPS: STANDBY</p>
            </div>
            <button onclick="copyForGemini()" class="text-[10px] bg-cyan-900/30 text-cyan-400 border border-cyan-800/50 px-3 py-1.5 rounded-full font-bold">
                ✨ Gemini連携
            </button>
        </header>

        <div id="tracker-card" class="bg-gray-800 rounded-[2.5rem] p-8 mb-6 shadow-2xl border border-gray-700/50 text-center">
            <div id="timer-display" class="font-mono-digit text-6xl font-black text-white mb-6">00:00:00</div>
            
            <div class="grid grid-cols-2 gap-4 mb-8 text-left">
                <div class="bg-gray-900/50 p-4 rounded-2xl border border-gray-700/30">
                    <p class="text-[9px] text-gray-500 uppercase font-black mb-1">Distance</p>
                    <p class="text-2xl font-black font-mono-digit text-white"><span id="live-dist">0.00</span><span class="text-xs ml-1 font-normal text-gray-500">KM</span></p>
                </div>
                <div class="bg-gray-900/50 p-4 rounded-2xl border border-gray-700/30">
                    <p class="text-[9px] text-gray-500 uppercase font-black mb-1">Pace</p>
                    <p class="text-2xl font-black font-mono-digit text-cyan-400"><span id="live-pace">-'-"</span></p>
                </div>
            </div>

            <div class="flex gap-3">
                <button id="btn-toggle" onclick="toggleTracking()" class="flex-[2] bg-blue-600 text-white py-5 rounded-2xl font-black text-xl active:scale-95 transition-all">
                    <span id="btn-text">START</span>
                </button>
                <button id="btn-pause" onclick="togglePause()" class="hidden flex-1 bg-gray-700 text-white py-5 rounded-2xl font-black text-xs active:scale-95 transition-all">
                    PAUSE
                </button>
            </div>
        </div>

        <div class="bg-gray-800/40 border border-gray-700/30 rounded-2xl p-4 mb-6">
            <p class="text-[10px] text-gray-500 font-black uppercase mb-2">Monthly Goal Progress</p>
            <div class="w-full bg-gray-900 h-1.5 rounded-full overflow-hidden">
                <div id="goal-bar" class="bg-blue-500 h-full w-0 transition-all duration-1000"></div>
            </div>
        </div>

        <div id="history-list" class="space-y-3"></div>
    </div>

    <script>
        let runs = JSON.parse(localStorage.getItem('cyberRunDataV5')) || [];
        let isTracking = false, isPaused = false;
        let watchId, startTime, timerInterval, totalDistance = 0, lastPosition = null;
        let pausedTime = 0, pauseStartTime = 0, lastLapDistance = 0;
        let wakeLock = null;
        
        const synth = window.speechSynthesis;

        window.onload = () => { renderHistory(); updateStats(); startGpsTracker(); };

        function speak(text) {
            if (synth.speaking) synth.cancel();
            const utter = new SpeechSynthesisUtterance(text);
            utter.lang = 'ja-JP';
            utter.rate = 1.0;
            synth.speak(utter);
        }

        async function requestWakeLock() {
            if ('wakeLock' in navigator) {
                try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {}
            }
        }

        function releaseWakeLock() {
            if (wakeLock) { wakeLock.release(); wakeLock = null; }
        }

        function startGpsTracker() {
            if (!navigator.geolocation) return;
            watchId = navigator.geolocation.watchPosition(handlePosition, 
                (err) => console.error(err), 
                { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
            );
        }

        function handlePosition(position) {
            const { latitude, longitude, accuracy, timestamp } = position.coords;
            document.getElementById('accuracy-text').innerText = `GPS: ACCURACY ${Math.round(accuracy)}M`;

            if (!isTracking || isPaused || accuracy > 30) return;

            if (lastPosition) {
                const dist = calculateDistance(lastPosition.latitude, lastPosition.longitude, latitude, longitude);
                if (dist < 0.005) return;

                totalDistance += dist;
                document.getElementById('live-dist').innerText = totalDistance.toFixed(2);
                
                // --- オートラップ機能 (1kmごと) ---
                if (Math.floor(totalDistance) > Math.floor(lastLapDistance)) {
                    lastLapDistance = totalDistance;
                    const currentPace = document.getElementById('live-pace').innerText;
                    speak(`${Math.floor(totalDistance)}キロ通過。現在のペースは${currentPace}です。`);
                }

                const timeElapsedMin = ((Date.now() - startTime) - pausedTime) / 60000;
                const pace = timeElapsedMin / totalDistance;
                document.getElementById('live-pace').innerText = `${Math.floor(pace)}'${Math.round((pace%1)*60).toString().padStart(2,'0')}"`;
            }
            lastPosition = { latitude, longitude, timestamp };
        }

        async function toggleTracking() {
            if (!isTracking) {
                await requestWakeLock();
                speak("ワークアウトを開始します。画面を消しても計測を続けます。");
                isTracking = true; totalDistance = 0; lastLapDistance = 0; startTime = Date.now(); pausedTime = 0;
                timerInterval = setInterval(updateTimer, 1000);
                document.getElementById('btn-text').innerText = "FINISH";
                document.getElementById('btn-toggle').classList.replace('bg-blue-600', 'bg-red-500');
                document.getElementById('btn-pause').classList.remove('hidden');
            } else {
                releaseWakeLock();
                stopSession();
            }
        }

        function updateTimer() {
            const diff = (Date.now() - startTime) - pausedTime;
            const h = Math.floor(diff / 3600000).toString().padStart(2, '0');
            const m = Math.floor((diff % 3600000) / 60000).toString().padStart(2, '0');
            const s = Math.floor((diff % 60000) / 1000).toString().padStart(2, '0');
            document.getElementById('timer-display').innerText = `${h}:${m}:${s}`;
        }

        function togglePause() {
            const btnPause = document.getElementById('btn-pause');
            if (!isPaused) {
                isPaused = true; pauseStartTime = Date.now();
                btnPause.innerText = "RESUME";
                speak("一時停止します。");
            } else {
                isPaused = false; pausedTime += (Date.now() - pauseStartTime);
                btnPause.innerText = "PAUSE";
                speak("再開します。");
            }
        }

        function stopSession() {
            clearInterval(timerInterval);
            if (totalDistance > 0.01) {
                const now = new Date();
                const dateStr = `${now.getMonth()+1}/${now.getDate()} ${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')}`;
                runs.unshift({ id: Date.now(), date: dateStr, distance: totalDistance, duration: ((Date.now()-startTime)-pausedTime)/60000, pace: (((Date.now()-startTime)-pausedTime)/60000)/totalDistance });
                localStorage.setItem('cyberRunDataV5', JSON.stringify(runs));
                renderHistory(); updateStats();
                speak(`計測完了。${totalDistance.toFixed(2)}キロ。保存しました。`);
            }
            isTracking = false; isPaused = false;
            document.getElementById('btn-text').innerText = "START";
            document.getElementById('btn-toggle').classList.replace('bg-red-500', 'bg-blue-600');
            document.getElementById('btn-pause').classList.add('hidden');
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2-lat1)*Math.PI/180;
            const dLon = (lon2-lon1)*Math.PI/180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function updateStats() {
            const monthDist = runs.reduce((s, r) => s + r.distance, 0);
            document.getElementById('goal-bar').style.width = Math.min((monthDist/100)*100, 100) + '%';
        }

        function copyForGemini() {
            const dataString = runs.slice(0, 5).map(r => `- ${r.date}: ${r.distance.toFixed(2)}km, ${Math.floor(r.pace)}'${Math.round((r.pace%1)*60)}"/km`).join('\n');
            navigator.clipboard.writeText(`最近のランを分析して：\n${dataString}`).then(() => alert("Gemini用プロンプトをコピー！"));
        }

        function renderHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = runs.map(run => `
                <div class="bg-gray-800/40 border border-gray-700/30 rounded-2xl p-4 flex justify-between items-center">
                    <div>
                        <p class="text-[9px] text-gray-500 font-bold">${run.date}</p>
                        <p class="text-lg font-black text-white font-mono-digit">${run.distance.toFixed(2)}<span class="text-[10px] ml-1 text-gray-400">KM</span></p>
                    </div>
                    <p class="text-sm font-black text-cyan-400 font-mono-digit">${Math.floor(run.pace)}'${Math.round((run.pace%1)*60).toString().padStart(2,'0')}"</p>
                </div>
            `).join('');
        }

        // アプリ復帰時にスリープ防止を再適用
        document.addEventListener('visibilitychange', async () => {
            if (wakeLock !== null && document.visibilityState === 'visible') await requestWakeLock();
        });
    </script>
</body>
</html>
